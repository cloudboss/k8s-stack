AWSTemplateFormatVersion: '2010-09-09'

Description: Kubernetes common resources

Parameters:
  VpcId:
    Description: ID of VPC where cluster will be placed
    Type: AWS::EC2::VPC::Id

Resources:
  ApiServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for kube-apiserver
      VpcId: !Ref VpcId

  ApiServerSecurityGroupHttpIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ApiServerSecurityGroup
      SourceSecurityGroupId: !Ref ApiServerSecurityGroup
      FromPort: 8080
      ToPort: 8080
      IpProtocol: tcp

  ApiServerSecurityGroupHttpEgress:
    Type: AWS::EC2::SecurityGroupEgress
    Properties:
      GroupId: !Ref ApiServerSecurityGroup
      DestinationSecurityGroupId: !Ref ApiServerSecurityGroup
      FromPort: 8080
      ToPort: 8080
      IpProtocol: tcp

  ApiServerSecurityGroupHttpsIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ApiServerSecurityGroup
      SourceSecurityGroupId: !Ref ApiServerSecurityGroup
      FromPort: 6443
      ToPort: 6443
      IpProtocol: tcp

  ApiServerSecurityGroupHttpsEgress:
    Type: AWS::EC2::SecurityGroupEgress
    Properties:
      GroupId: !Ref ApiServerSecurityGroup
      DestinationSecurityGroupId: !Ref ApiServerSecurityGroup
      FromPort: 6443
      ToPort: 6443
      IpProtocol: tcp

  KubeletSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for kubelet
      VpcId: !Ref VpcId

  KubeletSecurityGroupBgpIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref KubeletSecurityGroup
      SourceSecurityGroupId: !Ref KubeletSecurityGroup
      FromPort: 10250
      ToPort: 10250
      IpProtocol: tcp

  KubeletSecurityGroupBgpEgress:
    Type: AWS::EC2::SecurityGroupEgress
    Properties:
      GroupId: !Ref KubeletSecurityGroup
      DestinationSecurityGroupId: !Ref KubeletSecurityGroup
      FromPort: 10250
      ToPort: 10250
      IpProtocol: tcp

  KubeRouterSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for kube-router
      VpcId: !Ref VpcId

  KubeRouterSecurityGroupBgpIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref KubeRouterSecurityGroup
      SourceSecurityGroupId: !Ref KubeRouterSecurityGroup
      FromPort: 179
      ToPort: 179
      IpProtocol: tcp

  KubeRouterSecurityGroupBgpEgress:
    Type: AWS::EC2::SecurityGroupEgress
    Properties:
      GroupId: !Ref KubeRouterSecurityGroup
      DestinationSecurityGroupId: !Ref KubeRouterSecurityGroup
      FromPort: 179
      ToPort: 179
      IpProtocol: tcp

Outputs:
  ApiServerSecurityGroup:
    Description: Security group of kube-apiserver
    Value: !Ref ApiServerSecurityGroup
  KubeletSecurityGroup:
    Description: Security group of kube-router
    Value: !Ref KubeletSecurityGroup
  KubeRouterSecurityGroup:
    Description: Security group of kube-router
    Value: !Ref KubeRouterSecurityGroup
